#!/usr/bin/env bash
set -euo pipefail

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "${repo_root}"

staged_files="$(git diff --cached --name-only)"
if ! echo "${staged_files}" | grep -Eq '^servers/(core|template_server|self_team_allocation|intro_course|assessment)/'; then
  exit 0
fi

swag_bin=""
if command -v swag >/dev/null 2>&1; then
  swag_bin="swag"
else
  go_bin="$(go env GOBIN 2>/dev/null || true)"
  if [[ -z "${go_bin}" ]]; then
    go_bin="$(go env GOPATH 2>/dev/null || true)/bin"
  fi
  if [[ -n "${go_bin}" && -x "${go_bin}/swag" ]]; then
    swag_bin="${go_bin}/swag"
  fi
fi

if [[ -z "${swag_bin}" ]]; then
  echo "Error: swag is not installed or not on PATH."
  echo "Install with: go install github.com/swaggo/swag/cmd/swag@latest"
  echo "Then ensure \$GOPATH/bin (or \$GOBIN) is on PATH."
  exit 1
fi

if echo "${staged_files}" | grep -Eq '^servers/core/'; then
  SWAG_BIN="${swag_bin}" ./scripts/generate-api-spec.sh core
  git add servers/core/docs
fi

if echo "${staged_files}" | grep -Eq '^servers/template_server/'; then
  SWAG_BIN="${swag_bin}" ./scripts/generate-api-spec.sh template_server
  git add servers/template_server/docs
fi

if echo "${staged_files}" | grep -Eq '^servers/self_team_allocation/'; then
  SWAG_BIN="${swag_bin}" ./scripts/generate-api-spec.sh self_team_allocation
  git add servers/self_team_allocation/docs
fi

if echo "${staged_files}" | grep -Eq '^servers/intro_course/'; then
  SWAG_BIN="${swag_bin}" ./scripts/generate-api-spec.sh intro_course
  git add servers/intro_course/docs
fi

if echo "${staged_files}" | grep -Eq '^servers/assessment/'; then
  SWAG_BIN="${swag_bin}" ./scripts/generate-api-spec.sh assessment
  git add servers/assessment/docs
fi
