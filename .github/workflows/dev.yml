name: Build and Deploy to Dev

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  detect-migrations:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/detect-migrations.yml
    secrets: inherit
    permissions:
      contents: read
      pull-requests: write
  detect-changes:
    uses: ./.github/workflows/detect-changes.yml
    with:
      base_sha: ${{ github.event.pull_request.base.sha || github.event.before }}
    permissions:
      contents: read
      pull-requests: read
  generate-api-spec:
    needs: detect-changes
    uses: ./.github/workflows/generate-api-spec.yml
    secrets: inherit
    with:
      directories: ${{ needs.detect-changes.outputs.api_spec_directories }}
  lint-servers:
    needs: detect-changes
    uses: ./.github/workflows/lint-servers.yml
    secrets: inherit
    with:
      modules: ${{ needs.detect-changes.outputs.server_modules }}
  test-servers:
    needs: [detect-changes, lint-servers]
    uses: ./.github/workflows/test-servers.yml
    secrets: inherit
    with:
      directories: ${{ needs.detect-changes.outputs.server_modules }}
  build-servers:
    if: ${{ always() && !cancelled() && !contains(needs.*.result, 'failure') }}
    needs: [detect-changes, test-servers]
    uses: ./.github/workflows/build-and-push-servers.yml
    secrets: inherit
  lint-clients:
    needs: detect-changes
    uses: ./.github/workflows/lint-clients.yml
    secrets: inherit
    with:
      modules: ${{ needs.detect-changes.outputs.client_modules }}
  build-clients:
    if: ${{ always() && !cancelled() && !contains(needs.*.result, 'failure') }}
    needs: [detect-changes, lint-clients]
    uses: ./.github/workflows/build-and-push-clients.yml
    secrets: inherit
  deploy-dev:
    needs: [build-clients, build-servers]
    uses: ./.github/workflows/deploy-docker.yml
    secrets: inherit
    with:
      environment: prompt-dev-vm
      core_image_tag: ${{ needs.build-clients.outputs.core_image_tag }}
      template_image_tag: ${{ needs.build-clients.outputs.template_image_tag }}
      interview_image_tag: ${{ needs.build-clients.outputs.interview_image_tag }}
      matching_image_tag: ${{ needs.build-clients.outputs.matching_image_tag }}
      intro_course_developer_image_tag: ${{ needs.build-clients.outputs.intro_course_developer_image_tag }}
      assessment_image_tag: ${{ needs.build-clients.outputs.assessment_image_tag }}
      team_allocation_image_tag: ${{ needs.build-clients.outputs.team_allocation_image_tag }}
      self_team_allocation_image_tag: ${{ needs.build-clients.outputs.self_team_allocation_image_tag }}
      server_core_image_tag: ${{ needs.build-servers.outputs.server_core_image_tag }}
      server_intro_course_image_tag: ${{ needs.build-servers.outputs.server_intro_course_image_tag }}
      server_team_allocation_image_tag: ${{ needs.build-servers.outputs.server_team_allocation_image_tag }}
      server_assessment_image_tag: ${{ needs.build-servers.outputs.server_assessment_image_tag }}
      server_interview_image_tag: ${{ needs.build-servers.outputs.server_interview_image_tag }}
      devops_challenge_image_tag: ${{ needs.build-clients.outputs.devops_challenge_image_tag }}
      server_self_team_allocation_image_tag: ${{ needs.build-servers.outputs.server_self_team_allocation_image_tag }}
