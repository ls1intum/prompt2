name: Generate and Release API Spec

on:
  workflow_call:
    inputs:
      directories:
        description: "JSON array of server modules to generate API specs for"
        required: false
        type: string
  workflow_dispatch:

permissions:
  contents: read

jobs:
  resolve-directories:
    runs-on: ubuntu-latest
    outputs:
      directories: ${{ steps.resolve.outputs.directories }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - id: resolve
        env:
          INPUT_DIRECTORIES: ${{ inputs.directories }}
        run: |
          set -euo pipefail

          if [ -n "$INPUT_DIRECTORIES" ] && [ "$INPUT_DIRECTORIES" != '[]' ]; then
            DIRS="$INPUT_DIRECTORIES"
          else
            add_unique() {
              local list="$1"
              local value="$2"
              echo "$list" | jq --arg v "$value" 'if contains([$v]) then . else . + [$v] end'
            }

            is_api_spec_module() {
              local module="$1"
              local modfile="servers/$module/go.mod"
              if [ -f "$modfile" ] && grep -q "swaggo/swag" "$modfile"; then
                return 0
              fi
              return 1
            }

            DIRS="[]"
            if compgen -G "servers/*/" > /dev/null; then
              for dir in servers/*/; do
                module=$(basename "$dir")
                if is_api_spec_module "$module"; then
                  DIRS=$(add_unique "$DIRS" "$module")
                fi
              done
            fi
          fi

          {
            echo "directories<<EOF"
            echo "$DIRS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  generate-api-spec:
    runs-on: ubuntu-latest
    needs: resolve-directories
    if: needs.resolve-directories.outputs.directories != '[]'
    strategy:
      matrix:
        directory: ${{ fromJson(needs.resolve-directories.outputs.directories) }}

    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: "**/*.sum"
      - name: Install swag
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          echo "${HOME}/go/bin" >> $GITHUB_PATH
      - name: Generate API spec for ${{ matrix.directory }}
        run: |
          ./scripts/generate-api-spec.sh ${{ matrix.directory }}
      - name: Upload API spec artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-spec-${{ matrix.directory }}
          path: servers/${{ matrix.directory }}/docs/
