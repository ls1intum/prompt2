name: Detect Changes

on:
  workflow_call:
    outputs:
      server_modules:
        description: "JSON array of server modules that should run"
        value: ${{ jobs.detect.outputs.server_modules }}
      api_spec_directories:
        description: "JSON array of server modules that should generate API specs"
        value: ${{ jobs.detect.outputs.api_spec_directories }}
      client_modules:
        description: "JSON array of client modules that should run"
        value: ${{ jobs.detect.outputs.client_modules }}

permissions:
  contents: read

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      server_modules: ${{ steps.set-outputs.outputs.server_modules }}
      api_spec_directories: ${{ steps.set-outputs.outputs.api_spec_directories }}
      client_modules: ${{ steps.set-outputs.outputs.client_modules }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: tj-actions/changed-files@v45
        id: changed-servers
        with:
          files: servers/**
          dir_names: true
          dir_names_max_depth: 2
          json: true
      - uses: tj-actions/changed-files@v45
        id: changed-clients
        with:
          files: clients/**
          dir_names: true
          dir_names_max_depth: 2
          json: true
      - uses: tj-actions/changed-files@v45
        id: changed-workflows
        with:
          files: .github/workflows/**
      - uses: tj-actions/changed-files@v45
        id: changed-client-root
        with:
          files: |
            clients/package.json
            clients/yarn.lock
            clients/lerna.json
            clients/Dockerfile
            clients/eslint.config.mjs
      - uses: tj-actions/changed-files@v45
        id: changed-server-root
        with:
          files: |
            servers/go.mod
            servers/go.sum
      - id: set-outputs
        run: |
          set -euo pipefail

          workflows_changed="${{ steps.changed-workflows.outputs.any_changed }}"
          client_root_changed="${{ steps.changed-client-root.outputs.any_changed }}"
          server_root_changed="${{ steps.changed-server-root.outputs.any_changed }}"
          event_name="${{ github.event_name }}"
          force_all=false
          if [ "$event_name" = "release" ]; then
            force_all=true
          fi

          add_unique() {
            local list="$1"
            local value="$2"
            echo "$list" | jq --arg v "$value" 'if contains([$v]) then . else . + [$v] end'
          }

          server_modules="[]"
          if [ "$workflows_changed" = "true" ] || [ "$server_root_changed" = "true" ] || [ "$force_all" = "true" ]; then
            if compgen -G "servers/*/" > /dev/null; then
              for dir in servers/*/; do
                module=$(basename "$dir")
                [ -f "$dir/go.mod" ] && server_modules=$(add_unique "$server_modules" "$module")
              done
            fi
          else
            while IFS= read -r dir; do
              module=$(echo "$dir" | cut -d'/' -f2)
              [ -n "$module" ] && [ -f "servers/$module/go.mod" ] && server_modules=$(add_unique "$server_modules" "$module")
            done < <(echo '${{ steps.changed-servers.outputs.all_changed_files }}' | jq -r '.[]')
          fi

          client_modules="[]"
          if [ "$workflows_changed" = "true" ] || [ "$client_root_changed" = "true" ] || [ "$force_all" = "true" ]; then
            if compgen -G "clients/*/" > /dev/null; then
              for dir in clients/*/; do
                module=$(basename "$dir")
                [ -f "$dir/eslint.config.mjs" ] && client_modules=$(add_unique "$client_modules" "$module")
              done
            fi
          else
            while IFS= read -r dir; do
              module=$(echo "$dir" | cut -d'/' -f2)
              [ -n "$module" ] && [ -f "clients/$module/eslint.config.mjs" ] && client_modules=$(add_unique "$client_modules" "$module")
            done < <(echo '${{ steps.changed-clients.outputs.all_changed_files }}' | jq -r '.[]')
          fi

          is_api_spec_module() {
            local module="$1"
            local modfile="servers/$module/go.mod"
            if [ -f "$modfile" ] && grep -q "swaggo/swag" "$modfile"; then
              return 0
            fi
            return 1
          }

          api_spec_directories="[]"
          if [ "$workflows_changed" = "true" ] || [ "$server_root_changed" = "true" ] || [ "$force_all" = "true" ]; then
            if compgen -G "servers/*/" > /dev/null; then
              for dir in servers/*/; do
                module=$(basename "$dir")
                if is_api_spec_module "$module"; then
                  api_spec_directories=$(add_unique "$api_spec_directories" "$module")
                fi
              done
            fi
          else
            while IFS= read -r dir; do
              module=$(echo "$dir" | cut -d'/' -f2)
              if [ -n "$module" ] && is_api_spec_module "$module"; then
                api_spec_directories=$(add_unique "$api_spec_directories" "$module")
              fi
            done < <(echo '${{ steps.changed-servers.outputs.all_changed_files }}' | jq -r '.[]')
          fi

          {
            echo "server_modules<<EOF"
            echo "$server_modules"
            echo "EOF"
            echo "api_spec_directories<<EOF"
            echo "$api_spec_directories"
            echo "EOF"
            echo "client_modules<<EOF"
            echo "$client_modules"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
